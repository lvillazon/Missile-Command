<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MC</title>
    <style>
        .title {
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            font-size: x-large;
            color:gold;
        }

    </style>
</head>
<body bgcolor="brown">

    <table align="center">
        <tr>
            <td>
                <table style="width:100%" class = "title">
                    <tr>
                        <td>Missile Command</td>
                        <td style="text-align:center">Score: <span id="score">0</span></td>
                        <td style="text-align: right">Cities: <span id="cities">6</span></td>
                    </tr>
                </table>
                <table>
                    <tr>

                        <td>
                            <canvas id="gc" width="640" height="480">
                                Your browser does not support the HTML 5
                            </canvas>
                        </td>
                    </tr>
                </table>
                <table style="width:95%" class = "title" align="center">
                    <tr>
                        <!-- ammo remaining for bases -->
                        <td id="base1_ammo">0</td>
                        <td id="base2_ammo" style="text-align: center">0</td>
                        <td id="base3_ammo" style="text-align: right">0</td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

<script>
    const SCREEN_WIDTH = 640;
    const SCREEN_HEIGHT = 480;
    const GROUND = 10;

    var ctx = undefined;
    var canvas = undefined;

    var flakList = [];
    var missileList = [];
    var missileChance = 0.03;
    var baseList = [];
    var cityList = [];
    var score = 0;
    var citiesLeft = 6;
    var basesLeft = 3;
    var gameOver = false;

    window.onload=function() {
        canvas = document.getElementById("gc");
        ctx = canvas.getContext("2d");
        console.log("Starting...");
        addBase(0.05 * SCREEN_WIDTH, 10);
        addBase(0.5 * SCREEN_WIDTH, 10);
        addBase(0.95 * SCREEN_WIDTH, 10);
        addCity(0.1625 * SCREEN_WIDTH);
        addCity(0.275 * SCREEN_WIDTH);
        addCity(0.3975 * SCREEN_WIDTH);
        addCity(0.6125 * SCREEN_WIDTH);
        addCity(0.725 * SCREEN_WIDTH);
        addCity(0.8375 * SCREEN_WIDTH);
        document.addEventListener("mousedown", fire);
        setInterval(game, 1000/30);
    }

    function game() {
        // background
        ctx.fillStyle = "#b3ccff";
        ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = "green";
        ctx.fillRect(0,SCREEN_HEIGHT-GROUND, SCREEN_WIDTH, GROUND);

        // draw missile bases
        for (let i=0; i<baseList.length; i++) {
            if (!baseList[i].destroyed) {
                baseList[i].draw(ctx);
            }
        }

        // draw cities
        for (let i=0; i<cityList.length; i++) {
            //if (!cityList[i].destroyed) {
                cityList[i].draw(ctx);
            //}
        }

        // update all missile tracks
        ctx.strokeStyle = "red";
        for (let i=0; i<missileList.length; i++) {
            missileList[i].draw(ctx)
            missileList[i].update()
        }
        // remove oldest missile if it is dead
        if (missileList.length >0 && missileList[0].detonated) {
            missileList.shift();
        }

        // update all flak bursts
        ctx.fillStyle = "gold";
        ctx.globalCompositeOperation = "xor";  // creates overlap effect
        for (let i=0; i<flakList.length; i++) {
            flakList[i].draw(ctx);
            flakList[i].update();
        }
        ctx.globalCompositeOperation = "source-over";
        // remove the oldest burst if it has shrunk to nothing
        if (flakList.length >0 &&
            flakList[0].r <=0) {
            flakList.shift();
        }

        // chance of a new incoming missile
        if (Math.random() < missileChance) {
            initX = Math.random() * SCREEN_WIDTH
            addMissile(initX, 0);
        }
    }

    function fire(mouseEvent) {
        rect = mouseEvent.target.getBoundingClientRect();
        addFlak(mouseEvent.clientX - rect.left,
                mouseEvent.clientY - rect.top);
    }

    function addFlak(x, y) {
        const flak = {
            x: x,
            y: y,
            r: 1,
            phase: 0.1,
            maxSize: 50,
            draw(ctx) {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, 2*Math.PI);
                ctx.fill();
            },
            update() {
                // bursts grow and shrink according to sine function
                this.r = Math.sin(this.phase)*this.maxSize;
                if (this.r <0) {
                    this.r = 0;
                }
                this.phase += .01;            
            }
        }
        flakList.push(flak);
    }

    function addMissile(x, y) {
        missile = {
            startX: x,
            startY: y,
            x: x,
            y: 0,
            // pick a random point on the ground and aim for that
            vx: (Math.random() * SCREEN_WIDTH - x)/SCREEN_HEIGHT,
            vy: 1,
            detonated: false,
            remove: false,
            draw(ctx) {
                // draw track
                ctx.beginPath();
                ctx.moveTo(this.startX, this.startY);
                ctx.lineTo(this.x, this.y);
                ctx.stroke();
            },
            update() {
                if (!this.detonated) {
                    // move missile if it is still live
                    this.x += this.vx;
                    this.y += this.vy;
                    // check for flak collisions
                    if (this.hit()){
                        // set flag and move to the end of the list for removal
                        this.detonated = true;
                        missileList.sort(function(a,b){
                            // custom sorting so detonated missiles come before undetonated
                            return (a.detonated === b.detonated)? 0 : a.detonated? -1: 1;
                        });

                        // increment score
                        score += 10;
                        document.getElementById("score").innerText = score;
                        // create new explosion
                        addFlak(this.x, this.y);
                    }
                }
            },
            hit() {
                if (this.y > SCREEN_HEIGHT - GROUND) {
                    return true;
                }
                for (let i=0; i<flakList.length; i++) {
                    if (!this.detonated && this.inRange(flakList[i])) {
                        return true;
                    }
                }
                for (let i=0; i<cityList.length; i++) {
                    if (!this.detonated && this.inRange(cityList[i])) {
                        cityList[i].destroy();
                        return true;
                    }
                }
                return false;
            },
            inRange(target) {
                distance = Math.sqrt(
                Math.pow(this.x - target.x, 2) +
                Math.pow(this.y - target.y, 2));
                return (distance < target.r);

            },
        }
        missileList.push(missile);
    }

    function addBase(xPos, ammo) {
        base = {
            x: xPos,
            y: SCREEN_HEIGHT,
            hit: false,
            ammo: ammo,
            topWidth:20,
            bottomWidth: 50,
            height: 30,
            r: 30,
            destroyed: false,
            draw(ctx) {
                ctx.fillStyle = "green";
                ctx.beginPath();
                ctx.moveTo(this.x - this.bottomWidth/2, this.y);
                ctx.lineTo(this.x + this.bottomWidth/2, this.y);
                ctx.lineTo(this.x + this.topWidth/2, this.y - this.height);
                ctx.lineTo(this.x - this.topWidth/2, this.y - this.height);
                ctx.closePath();
                ctx.fill();
            }
        }
        baseList.push(base);
    }

    function addCity(xPos) {
        city = {
            x: xPos,
            y: SCREEN_HEIGHT-GROUND,
            hit: false,
            width: 50,
            height: 30,
            r: 30,
            buildings: [2,5,10,4,8,3,7,6,3,6,2],
            destroyed: false,
            draw(ctx) {
                ctx.fillStyle = "green";
                for(let i=0; i<this.buildings.length; i++) {
                    ctx.fillRect(this.x -this.width/2 +(this.width/this.buildings.length*i), 
                                 this.y - this.height/10*this.buildings[i],
                                 this.width/this.buildings.length,
                                 this.height/10*this.buildings[i]
                    );
                }
            },
            destroy() {
                if (!this.destroyed) {
                    this.destroyed = true;
                    this.buildings = [0,0,1,2,1,3,0,1,0,0,1]
                    citiesLeft -= 1;
                    document.getElementById("cities").innerText = citiesLeft;
                    if (citiesLeft == 0) {
                        gameOver = true;
                    }
                }
            },
        }
        cityList.push(city);
    }

    // don't need this, but saving for later, just in case
    function keyPush(event) {
        switch(event.keyCode) {
            case 37:  // left
                if (px>0) {
                    px -= 1;
                }
                break;
            case 38:  // up
                break;
            case 39:  // right
                if (px < gridWidth-1) {
                    px += 1;
                }
                break;
            case 40:  // down
                break;
        }
    }
</script>

</body>
</html>
